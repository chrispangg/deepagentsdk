---
title: Implementation Notes - 2024-12-24
date: 2024-12-24 20:00:00 AEDT
context: Phase 1 implementation - multiple issues discovered and fixed
---

## Summary

Three separate issues were identified and fixed during Phase 1 implementation:

### Issue 1: First Prompt Ignored (Original Bug)
**Location**: `src/cli/hooks/useAgent.ts:676`

**Problem**: Empty `messages` array (`[]`) was passed to `streamWithEvents`, causing the `prompt` parameter to be ignored.

**Fix**: Conditional check to pass `undefined` instead of empty array.

### Issue 2: Empty Assistant Message Content
**Location**: `src/agent.ts:991-995`

**Problem**: When `finalText` is empty (tool-only responses), assistant message with empty content was created, violating Anthropic's API.

**Fix**: Conditional spread to only include assistant message if `finalText` is non-empty.

### Issue 3: Subsequent Prompts Lost
**Location**: `src/cli/hooks/useAgent.ts:673-686`

**Problem**: On second/subsequent prompts, conversation history was passed but the new user prompt was not appended to it. The `buildMessageArray` function uses the `messages` array and ignores the `prompt` parameter when `messages.length > 0`.

**Fix**: Always build the `inputMessages` array by appending the new prompt to existing history. Only use `messages` parameter, never use `prompt` parameter.

## Detailed Analysis of Issue 3

### The Bug Flow

**First prompt** (works):
```typescript
messages = []  // Empty from initial state
inputMessages = undefined  // Original fix passed undefined
// streamWithEvents({ prompt: "hello", messages: undefined })
// buildMessageArray converts prompt to message ✓
```

**Second prompt** (broken):
```typescript
messages = [{ role: "user", content: "hello" }, { role: "assistant", content: "..." }]
inputMessages = messages  // Original fix passed the array
// streamWithEvents({ prompt: "what can you do", messages: [...] })
// buildMessageArray sees messages.length > 0, uses messages, ignores prompt ✗
// Result: New user input "what can you do" is lost!
```

### The Fix

Always build the messages array properly:

```typescript
const inputMessages = messagesRef.current.length > 0
  ? [
      ...messagesRef.current,  // Existing conversation
      { role: "user", content: prompt } as ModelMessage,  // NEW message
    ]
  : [{ role: "user", content: prompt } as ModelMessage];  // First message

// Always pass messages parameter (never prompt)
streamWithEvents({
  messages: inputMessages,
  // ...no prompt parameter
})
```

This ensures:
1. First prompt: `[{ role: "user", content: "hello" }]`
2. Second prompt: `[{ role: "user", content: "hello" }, { role: "assistant", content: "..." }, { role: "user", content: "what can you do" }]`

## All Changes Made

### 1. src/cli/hooks/useAgent.ts (lines 663-686)

Changed from:
```typescript
for await (const event of agentRef.current.streamWithEvents({
  prompt,  // ← Problem: ignored when messages.length > 0
  state,
  messages: messagesRef.current.length > 0 ? messagesRef.current : undefined,
  // ...
}))
```

To:
```typescript
// Build the input messages array for streamWithEvents
// Append the new prompt to the conversation history (if any exists)
const inputMessages = messagesRef.current.length > 0
  ? [
      ...messagesRef.current,
      { role: "user", content: prompt } as ModelMessage,
    ]
  : [{ role: "user", content: prompt } as ModelMessage];

for await (const event of agentRef.current.streamWithEvents({
  messages: inputMessages,  // ← Always use messages (never prompt parameter)
  state,
  // ...
}))
```

### 2. src/agent.ts (lines 991-996)

Changed from:
```typescript
const updatedMessages: ModelMessage[] = [
  ...inputMessages,
  { role: "assistant", content: finalText } as ModelMessage,
];
```

To:
```typescript
const updatedMessages: ModelMessage[] = [
  ...inputMessages,
  ...(finalText ? [{ role: "assistant", content: finalText } as ModelMessage] : []),
];
```

## Testing Verification

- ✅ Type checking passes
- ✅ Unit tests pass (214 tests)
- ⏳ Manual testing pending

## Impact on Plan

This represents a more significant fix than initially planned. Instead of a one-line conditional check, we now:

1. Always build the messages array explicitly
2. Never use the deprecated `prompt` parameter in streamWithEvents
3. Always append new user input to conversation history

This is actually cleaner and more maintainable than the original approach, as it consistently uses the `messages` parameter throughout.
