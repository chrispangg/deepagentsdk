---
date: 2026-01-08
context: Implementing Phase 1 (Adapter Hook) for AI SDK Elements Integration
---

# Implementation Notes - 2026-01-08

## Implementation Summary

Completed Phase 1 implementation of AI SDK Elements Integration:

### Files Created
1. `src/adapters/elements/types.ts` - TypeScript type definitions for UIMessage, UIMessagePart, etc.
2. `src/adapters/elements/statusAdapter.ts` - Maps AgentStatus to Elements UIStatus
3. `src/adapters/elements/messageAdapter.ts` - Converts DeepAgentEvent to UIMessage format
4. `src/adapters/elements/useElementsAdapter.ts` - Main React hook adapter
5. `src/adapters/elements/index.ts` - Barrel export

### Key Design Decisions

#### 1. Independent Hook Implementation
**Decision**: Create `useElementsAdapter` as standalone hook instead of wrapping `useAgent` from CLI.

**Reasoning**:
- `useAgent` is CLI-specific and uses `parseModelString()` to convert string → LanguageModel
- Elements adapter needs to accept `LanguageModel` instances directly (standard AI SDK pattern)
- Wrapping would add unnecessary indirection and CLI dependencies

**Implementation**: `useElementsAdapter` calls `createDeepAgent` directly and manages its own React state.

#### 2. Message Parameter (not prompt)
**Change**: Use `messages` parameter instead of deprecated `prompt` parameter.

**Code**:
```typescript
streamWithEvents({
  messages: [{ role: "user", content: message.text }],
  state,
  abortSignal,
})
```

#### 3. Event-to-UIMessage Transformation
**Pattern**: Convert event log to UIMessage array with proper grouping:
- User messages create user UIMessage
- Text segments, tool calls, and tool results accumulate into assistant UIMessage
- Streaming text added as in-progress message with "streaming" status

### Test Setup Requirements

#### DOM Environment for React Testing
**Issue**: `@testing-library/react` requires DOM globals (document, window)

**Solution**: Setup jsdom at top of test file:
```typescript
import { JSDOM } from "jsdom";
const dom = new JSDOM("<!DOCTYPE html><html><body></body></html>", {
  url: "http://localhost",
});
global.document = dom.window.document;
global.window = dom.window as any;
```

#### Tool Schema Format
**Issue**: AI SDK v6 expects Zod schemas or properly wrapped JSON schemas. Raw objects cause "schema is not a function" error.

**Current Test Code** (needs fixing):
```typescript
tools: {
  test_tool: {
    description: "Test tool",
    inputSchema: { type: "object", properties: {} }, // ❌ Raw object
    execute: async () => "result",
  },
}
```

**Should be** (using Zod):
```typescript
import { z } from "zod";

tools: {
  test_tool: {
    description: "Test tool",
    inputSchema: z.object({}), // ✅ Zod schema
    execute: async () => "result",
  },
}
```

### Test Results (In Progress)

**Passing Tests** (3/40):
- ✅ should initialize with empty messages and ready status
- ✅ should provide sendMessage callback
- ✅ should provide abort and clear callbacks

**Failing Tests**: Most tests timing out because:
1. Mock model not triggering proper events
2. Tool schemas need Zod wrapping
3. Some tests need actual streaming/tool execution to complete

### Next Steps

1. Fix tool schemas in test file to use Zod
2. Improve mock model to generate proper streaming events
3. Handle multi-turn conversation state persistence
4. Add tool result matching by toolCallId

### Dependencies Added
- `@testing-library/react@^16.3.1` (devDependencies)
- `react-dom@^18.3.1` (devDependencies) - Match React 18.x

### Package.json Changes
Added Elements adapter export:
```json
"./elements": {
  "import": "./src/adapters/elements/index.ts",
  "types": "./src/adapters/elements/index.ts"
}
```

## Impact on Plan

No changes to the original plan needed. Implementation follows ticket spec closely.

## Known Issues

1. **Mock model limitations**: Tests use simple mock that may not trigger all event types
2. **Deprecated prompt parameter**: Fixed by using `messages` parameter
3. **Tool schema validation**: Tests need updating to use Zod schemas

## Future Considerations

### Phase 2 Preparation
When splitting packages (`@deepagentsdk/core`, `@deepagentsdk/react`, `@deepagentsdk/elements`):
- Keep `useElementsAdapter` in `@deepagentsdk/elements`
- Extract `AgentStatus` and `AgentEventLog` types to `@deepagentsdk/core`
- Consider creating base `useDeepAgent` hook in `@deepagentsdk/react` that both `useAgent` (CLI) and `useElementsAdapter` can use
